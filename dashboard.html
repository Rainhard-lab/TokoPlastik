<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/dashboard.css">
</head>
<body>
<div class="sidebar">
  <h2>TokoPlastik</h2>
  <a href="dashboard.html" class="active">Dashboard</a>
  <a href="staff.html">Staff</a>
  <a href="inventory.html">Inventory</a>
  <a href="reports.html">Reports</a>
  <a href="kasir.html">Kasir</a>
  <a href="login.html">Logout</a>
</div>

<div class="main">
  <div class="container-fluid my-4">
    <div id="dashboard" class="d-flex flex-wrap justify-content-between align-items-center mb-4">
      <h2 class="fw-bold text-primary mb-2">üè† Dashboard</h2>
    </div>
    <div class="cards">
      <div class="card">
        <h3>Penjualan Harian</h3>
        <p id="penjualan-harian">Rp 0</p>
        <small class="tanggal1" id="tanggal-harian"></small>
      </div>
      <div class="card">
        <h3>Penjualan Bulanan</h3>
        <p id="penjualan-bulanan">Rp 0</p>
        <small class="tanggal1" id="tanggal-bulanan"></small>
      </div>
      <div class="card">
        <h3>Stok Hampir Habis</h3>
        <ul id="stok-habis"></ul>
      </div>
      <div class="card">
        <h3>Produk Terlaris</h3>
        <ul id="produk-terlaris"></ul>
      </div>
    </div>

    <div class="chart">
      <h3>Overview</h3>
      <canvas id="overviewChart"></canvas>
    </div>
  </div>
</div>

<script>
async function loadData() {
  const transaksi = await (await fetch("data/transaksi.json")).json();
  const produk = await (await fetch("data/produk.json")).json();
  const detail = await (await fetch("data/transaksi_detail.json")).json();

  // --- Penjualan Harian & Bulanan ---
  const today = new Date().toISOString().slice(0,10);
  const thisMonth = new Date().getMonth() + 1;
  const thisYear = new Date().getFullYear();

  const harian = transaksi
    .filter(t => t.created_at.startsWith(today))
    .reduce((a,b) => a + parseFloat(b.total), 0);

  const bulanan = transaksi
    .filter(t => {
      const d = new Date(t.created_at);
      return d.getMonth()+1 === thisMonth && d.getFullYear() === thisYear;
    })
    .reduce((a,b) => a + parseFloat(b.total), 0);

  document.getElementById("penjualan-harian").textContent = "Rp " + harian.toLocaleString("id-ID");
  document.getElementById("penjualan-bulanan").textContent = "Rp " + bulanan.toLocaleString("id-ID");
  document.getElementById("tanggal-harian").textContent = new Date().toLocaleDateString("id-ID", {day:"numeric", month:"long", year:"numeric"});
  document.getElementById("tanggal-bulanan").textContent = new Date().toLocaleDateString("id-ID", {month:"long", year:"numeric"});

  // --- Produk Hampir Habis ---
  const habis = [...produk].sort((a,b) => a.stok - b.stok).slice(0,5);
  document.getElementById("stok-habis").innerHTML = habis.map(p => `<li>${p.nama_produk} (${p.stok})</li>`).join("");

  // --- Produk Terlaris ---
  const jualMap = {};
  detail.forEach(d => {
    if (!jualMap[d.id_produk]) jualMap[d.id_produk] = 0;
    jualMap[d.id_produk] += parseInt(d.jumlah);
  });
  const terlaris = Object.entries(jualMap)
    .map(([id,jumlah]) => {
      const p = produk.find(pr => pr.id_produk == id);
      return {nama: p.nama_produk, terjual: jumlah};
    })
    .sort((a,b) => b.terjual - a.terjual)
    .slice(0,5);
  document.getElementById("produk-terlaris").innerHTML = terlaris.map(t => `<li>${t.nama} (${t.terjual} terjual)</li>`).join("");

  // --- Grafik Bulanan ---
  const bulanMap = {};
  transaksi.forEach(t => {
    const d = new Date(t.created_at);
    const key = d.getMonth();
    if (!bulanMap[key]) bulanMap[key] = {sales:0, revenue:0};
    bulanMap[key].sales += 1;
    bulanMap[key].revenue += parseFloat(t.total);
  });

  const labels = Object.keys(bulanMap).map(m => new Date(2023, m, 1).toLocaleString("id-ID", {month:"short"}));
  const sales = Object.values(bulanMap).map(b => b.sales);
  const revenue = Object.values(bulanMap).map(b => b.revenue);

  new Chart(document.getElementById('overviewChart'), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {label: 'Sales', data: sales, borderColor: '#ff80ab', fill: false, tension: 0.3},
        {label: 'Revenue', data: revenue, borderColor: '#ffffff', fill: false, tension: 0.3}
      ]
    },
    options: {
      responsive: true,
      plugins: { legend: { labels: { color: '#fff' } } },
      scales: {
        x: { ticks: { color: '#fff' } },
        y: { ticks: { color: '#fff' } }
      }
    }
  });
}
loadData();
</script>
</body>
</html>
